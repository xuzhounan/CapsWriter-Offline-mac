# 🔍 CapsWriter-mac Code Review 专用 Prompt

## 🎯 **Code Review Prompt** (复制使用)

```
🔍 请对 CapsWriter-mac 项目进行全面的代码审查

项目路径: /Users/xzn/Desktop/code-project/CapsWriter-Offline-mac

⚠️ 重要说明: 我需要你以代码审查专家的角色，严格审查最近的代码更改，发现潜在的 bug 和问题。

📋 审查目标:
1. 分析最近的 Git 提交和代码更改
2. 识别潜在的 bug、逻辑错误和架构问题
3. 检查代码质量、性能和安全问题
4. 提供具体的修复建议和改进方案

🔍 请执行以下审查流程:

1. **Git 历史分析**:
   - 检查最近 3-5 次提交: git log --oneline -5
   - 查看最新提交的详细更改: git show HEAD
   - 分析修改的文件和代码行数: git diff --stat HEAD~3..HEAD

2. **文件变更审查**:
   - 检查项目当前状态: git status
   - 查看主要源文件的变更内容
   - 重点关注以下关键文件:
     * AppDelegate.swift
     * VoiceInputController.swift (如存在)
     * 各种 Service 类
     * 状态管理类 (AudioState, RecognitionState, AppState)
     * 配置管理类 (ConfigurationManager)

3. **代码质量检查**:
   ✅ 编译问题检查
   ✅ 内存泄漏风险
   ✅ 线程安全问题
   ✅ 异常处理完整性
   ✅ 循环引用隐患
   ✅ API 使用正确性
   ✅ 逻辑一致性
   ✅ 性能潜在问题

4. **架构合理性审查**:
   ✅ 模块职责是否清晰
   ✅ 依赖关系是否合理
   ✅ 接口设计是否恰当
   ✅ 事件处理是否正确
   ✅ 状态管理是否一致

📊 输出格式要求:

### 🔴 严重问题 (Critical Issues)
- [问题描述] 在 [文件名:行号]
- **影响**: [具体影响]
- **修复建议**: [详细修复方案]

### 🟡 重要问题 (Major Issues)  
- [问题描述] 在 [文件名:行号]
- **影响**: [具体影响]
- **修复建议**: [详细修复方案]

### 🟢 轻微问题 (Minor Issues)
- [问题描述] 在 [文件名:行号]
- **建议**: [改进建议]

### ✅ 正面评价 (Positive Feedback)
- [好的设计或实现] 在 [文件名:行号]
- **价值**: [说明价值]

### 📋 总体评分
- **代码质量**: X/10
- **架构设计**: X/10  
- **安全性**: X/10
- **性能**: X/10
- **可维护性**: X/10

### 🚀 优先修复建议
1. [最高优先级问题]
2. [次高优先级问题] 
3. [其他建议]

⚠️ 注意: 请特别关注可能导致崩溃、内存泄漏、死锁、数据丢失等严重问题的代码。
```

---

## 🔍 **专门问题检查 Prompt** (针对特定问题)

### **内存泄漏检查 Prompt**
```
🔍 专项检查: 内存泄漏和循环引用

请专门检查 CapsWriter-mac 项目的内存管理问题:

项目路径: /Users/xzn/Desktop/code-project/CapsWriter-Offline-mac

🎯 检查重点:
1. 强引用循环 (retain cycles)
2. 委托模式中的 weak 引用使用
3. 闭包中的 self 捕获
4. Timer 和 Observer 的释放
5. C API 资源的释放 (Sherpa-ONNX)

请分析以下文件:
- AppDelegate.swift  
- VoiceInputController.swift
- 各种 Service 类
- 状态管理类

输出具体的内存泄漏风险点和修复方案。
```

### **线程安全检查 Prompt**  
```
🔍 专项检查: 线程安全和并发问题

请专门检查 CapsWriter-mac 项目的线程安全问题:

项目路径: /Users/xzn/Desktop/code-project/CapsWriter-Offline-mac

🎯 检查重点:
1. @MainActor 使用正确性
2. DispatchQueue 使用规范性
3. 共享状态的并发访问
4. 音频处理的线程安全
5. UI 更新的主线程要求

请特别关注:
- 音频采集和处理逻辑
- 状态管理类的并发访问
- 事件总线的线程安全
- 配置管理的并发更新

输出具体的线程安全问题和修复方案。
```

### **性能问题检查 Prompt**
```
🔍 专项检查: 性能瓶颈和优化

请专门检查 CapsWriter-mac 项目的性能问题:

项目路径: /Users/xzn/Desktop/code-project/CapsWriter-Offline-mac

🎯 检查重点:
1. 主线程阻塞风险
2. 频繁的内存分配
3. 不必要的计算重复
4. I/O 操作效率
5. 事件处理性能

请分析:
- 音频实时处理性能
- UI 响应性能
- 语音识别延迟
- 配置加载性能
- 事件分发效率

输出性能瓶颈和优化建议。
```

---

## 📋 **Code Review 检查清单**

### **必检项目**
- [ ] **编译检查**: 代码能否正常编译
- [ ] **逻辑完整性**: 业务逻辑是否完整正确
- [ ] **异常处理**: 错误情况是否被正确处理
- [ ] **内存管理**: 是否存在内存泄漏风险
- [ ] **线程安全**: 并发访问是否安全
- [ ] **API 正确性**: 系统 API 使用是否正确

### **架构检查**
- [ ] **单一职责**: 每个类是否职责明确
- [ ] **依赖倒置**: 是否依赖接口而非实现
- [ ] **开闭原则**: 是否易于扩展难以修改
- [ ] **接口隔离**: 接口是否简洁合理
- [ ] **配置管理**: 配置是否统一管理

### **代码质量**
- [ ] **命名规范**: 变量、方法命名是否清晰
- [ ] **代码注释**: 复杂逻辑是否有注释
- [ ] **代码重复**: 是否存在重复代码
- [ ] **魔法数字**: 是否存在硬编码常量
- [ ] **代码结构**: 代码组织是否清晰

### **特定问题**
- [ ] **权限处理**: macOS 权限申请是否正确
- [ ] **音频处理**: 音频采集和处理是否规范
- [ ] **事件处理**: 事件分发和处理是否正确
- [ ] **状态同步**: 多个状态管理器是否同步
- [ ] **资源清理**: 应用退出时资源是否正确释放

---

## 🚨 **常见问题模式**

### **Swift 特有问题**
1. **强引用循环**: `[weak self]` 使用不当
2. **可选类型**: 强制解包导致崩溃
3. **并发问题**: `@MainActor` 使用错误
4. **内存管理**: C API 资源未释放

### **macOS 特有问题**  
1. **权限处理**: 权限申请时机不当
2. **沙盒限制**: 文件访问权限问题
3. **后台运行**: 后台状态管理错误
4. **系统集成**: Carbon API 使用不当

### **架构问题**
1. **循环依赖**: 模块间相互依赖
2. **职责不清**: 类承担过多职责
3. **状态不一致**: 多个状态源冲突
4. **事件丢失**: 事件订阅/取消订阅不匹配

---

## 💡 **使用建议**

1. **定期审查**: 每完成一个功能模块后进行审查
2. **重点关注**: 关键路径和复杂逻辑优先审查
3. **工具辅助**: 结合 Xcode 静态分析和单元测试
4. **文档记录**: 审查结果要记录到项目文档中

这套 Code Review 体系将帮助你及时发现和解决代码问题，保证项目的质量和稳定性！